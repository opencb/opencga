<!--
~ Copyright 2015-2016 OpenCB
~
~ Licensed under the Apache License, Version 2.0 (the "License");
~ you may not use this file except in compliance with the License.
~ You may obtain a copy of the License at
~
~     http://www.apache.org/licenses/LICENSE-2.0
~
~ Unless required by applicable law or agreed to in writing, software
~ distributed under the License is distributed on an "AS IS" BASIS,
~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
~ See the License for the specific language governing permissions and
~ limitations under the License.
-->

<link rel="import" href="../node_modules/@polymer/polymer/polymer-element.html">
<link rel="import" href="../node_modules/@polymer/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../node_modules/@polymer/polymer/lib/elements/dom-if.html">
<link rel="import" href="../node_modules/@polymer/polymer/lib/elements/array-selector.html">
<link rel="import" href="../node_modules/@polymer/polymer/lib/elements/custom-style.html">
<link rel="import" href="jso-styles.html">
<link rel="import" href="welcome.html">

<link rel="import" href="../lib/jsorolla/src/core/webcomponents/opencga/opencga-genome-browser.html">
<link rel="import" href="../lib/jsorolla/src/core/webcomponents/opencga/variant/opencga-variant-browser.html">
<link rel="import" href="../lib/jsorolla/src/core/webcomponents/opencga/variant/opencga-variant-interpretation.html">
<link rel="import" href="../lib/jsorolla/src/core/webcomponents/opencga/variant/opencga-variant-facet.html">
<link rel="import" href="../lib/jsorolla/src/core/webcomponents/opencga/clinical/clinical-interpretation-view.html">
<link rel="import" href="../lib/jsorolla/src/core/webcomponents/opencga/clinical/opencga-variant-clinical.html">
<link rel="import" href="../lib/jsorolla/src/core/webcomponents/opencga/opencga-panel.html">
<link rel="import" href="../lib/jsorolla/src/core/webcomponents/opencga/variant/variant-beacon.html">
<link rel="import" href="../lib/jsorolla/src/core/webcomponents/opencga/variant/variant-jobs.html">

<link rel="import" href="../lib/jsorolla/src/core/webcomponents/opencga/opencga-gene-view.html">
<link rel="import" href="../lib/jsorolla/src/core/webcomponents/opencga/opencga-transcript-view.html">
<link rel="import" href="../lib/jsorolla/src/core/webcomponents/opencga/opencga-protein-view.html">
<link rel="import" href="../lib/jsorolla/src/core/webcomponents/opencga/catalog/opencga-projects.html">
<link rel="import" href="../lib/jsorolla/src/core/webcomponents/opencga/catalog/opencga-project.html">
<link rel="import" href="../lib/jsorolla/src/core/webcomponents/opencga/catalog/samples/opencga-sample-browser.html">
<link rel="import" href="../lib/jsorolla/src/core/webcomponents/opencga/catalog/cohorts/opencga-cohort-browser.html">
<!--<link rel="import" href="../lib/jsorolla/src/core/opencga/catalog/opencga-study.html">-->
<link rel="import" href="../lib/jsorolla/src/core/webcomponents/opencga/catalog/opencga-login.html">
<!--<link rel="import" href="iva-settings.html">-->


<dom-module id="catalog-app">

    <template>
        <custom-style>
            <style include="jso-styles">
                .center {
                    margin: auto;
                    text-align: justify;
                    width: 60%;
                    font-size: 18px;
                    color: #797979;
                }

                .feature-view {
                    margin: auto;
                    text-align: justify;
                    width: 90%;
                }
            </style>
        </custom-style>

        <div>
            <div style="height: 60px;">
                <nav class="navbar navbar-inverse navbar-fixed-top">
                    <div class="container-fluid">

                        <!-- Brand and toggle get grouped for better mobile display -->
                        <div class="navbar-header">
                            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                                    data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                                <span class="sr-only">Toggle navigation</span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                            </button>
                            <a href="#home" class="navbar-brand" style="padding-top: 10px" on-click="changeTool">
                                <img src="{{config.logo}}" width="100px">
                            </a>
                            <a class="navbar-brand" href="#home" on-click="changeTool">
                                <b>{{config.title}} {{config.version}}</b>
                            </a>
                        </div>


                        <!-- Collect the nav links, forms, and other content for toggling -->
                        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">

                            <!-- Controls aligned to the LEFT -->
                            <ul class="nav navbar-nav">
                                <!-- This code parse the config menu arrays and creates a custom menu taken into account visibility -->
                                <template is="dom-repeat" items="{{config.menu}}" filter="_isMenuItemVisible" as="menuItem">
                                    <!-- If there is not submenu we just display a button -->
                                    <template is="dom-if" if="{{!menuItem.submenu}}">
                                        <li on-click="changeTool">
                                            <a href$="#{{menuItem.id}}" role="button">{{menuItem.title}}</a>
                                        </li>
                                    </template>
                                    <!-- If there is a submenu we create a dropdown menu item -->
                                    <template is="dom-if" if="{{menuItem.submenu}}">
                                        <li class="dropdown">
                                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                                                {{menuItem.title}} <span class="caret"></span>
                                            </a>
                                            <ul class="dropdown-menu">
                                                <template is="dom-repeat" items="{{menuItem.submenu}}" filter="_isMenuItemVisible">
                                                    <template is="dom-if" if="{{item.category}}">
                                                        <li>
                                                            <a><label>{{item.title}}</label></a>
                                                        </li>
                                                    </template>
                                                    <template is="dom-if" if="{{item.separator}}">
                                                        <li role="separator" class="divider"></li>
                                                    </template>
                                                    <template is="dom-if" if="{{!item.category}}">
                                                        <template is="dom-if" if="{{!item.separator}}">
                                                            <li on-click="changeTool">
                                                                <a href$="#{{item.id}}" data-id="{{item.id}}">{{item.title}}</a>
                                                            </li>
                                                        </template>
                                                    </template>
                                                </template>
                                            </ul>
                                        </li>
                                    </template>
                                </template>
                            </ul>

                            <!-- Controls aligned to the RIGHT: settings and about-->
                            <ul class="nav navbar-nav navbar-right" >
                                <!--User-->
                                <template is="dom-if" if="{{opencgaSession.token}}">
                                    <li>
                                        <a style="padding: 0px; margin-top: 8px"><i class="fa fa-user fa-2x" aria-hidden="true"></i></a>
                                    </li>
                                    <li class="dropdown">
                                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                                            {{opencgaSession.user.id}} <span class="caret"></span>
                                        </a>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <a href="#projects"><i class="fa fa-database" aria-hidden="true" style="padding-right: 10px"></i>Projects</a>
                                            </li>
                                            <li>
                                                <a href="#samples"><i class="fa fa-users" aria-hidden="true" style="padding-right: 10px"></i>Samples</a>
                                            </li>
                                            <!--<li>-->
                                            <!--<a data-target="#jobModal" data-toggle="modal"><i class="fa fa-bars" aria-hidden="true"></i> Jobs</a>-->
                                            <!--</li>-->
                                            <li role="separator" class="divider"></li>
                                            <li>
                                                <a href="#settings"><i class="fa fa-cog" aria-hidden="true"></i> Settings</a>
                                            </li>
                                        </ul>
                                    </li>
                                </template>

                                <!--Studies dropdown and Search menu-->
                                <template is="dom-if" if="{{opencgaSession.projects.length}}">
                                    <li class="dropdown">
                                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button"
                                           aria-haspopup="true" aria-expanded="false"> Studies <span class="caret"></span>
                                        </a>
                                        <ul class="dropdown-menu pre-scrollable">
                                            <template is="dom-repeat" items="{{opencgaSession.projects}}" as="proj">
                                                <li><a><b>{{proj.name}}</b></a></li>
                                                <template is="dom-repeat" items="{{proj.studies}}" as="std">
                                                    <li>
                                                        <a href="#" data-study="{{std.alias}}" data-project="{{proj.name}}" on-click="onStudySelect">{{std.alias}}</a>
                                                    </li>
                                                </template>
                                            </template>
                                        </ul>
                                    </li>

                                    <template is="dom-if" if="{{config.search.visible}}">
                                        <form class="navbar-form navbar-left" role="search">
                                            <div class="form-group">
                                                <input type="text" class="form-control" id="searchTextBox"
                                                       placeholder="{{config.search.placeholder}}" on-keyup="buildQuery" style="width: 180px;">
                                                <a style="cursor: pointer">
                                                    <span class="fa fa-search" aria-hidden="true" on-click="buildQuery"></span>
                                                </a>
                                            </div>
                                        </form>
                                    </template>
                                </template>

                                <!-- About dropdown menu-->
                                <li class="dropdown">
                                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button"
                                       aria-haspopup="true" aria-expanded="false"> About <span class="caret"></span>
                                    </a>
                                    <ul class="dropdown-menu">
                                        <template is="dom-repeat" items="{{config.about}}">
                                            <li>
                                                <a href$="{{item.url}}" target="_blank"><i class$="{{item.icon}}" aria-hidden="true"></i>
                                                    {{item.name}}
                                                </a>
                                            </li>
                                        </template>
                                    </ul>
                                </li>

                                <!-- Login/Logout button -->
                                <template is="dom-if" if="{{config.login.visible}}">
                                    <li>
                                        <template is="dom-if" if="{{!opencgaSession.token}}">
                                            <a href="#login" id="loginButton" role="button" on-click="changeTool">
                                                <i href="#login" class="fa fa-sign-in fa-lg" aria-hidden="true"></i> Login
                                            </a>
                                        </template>
                                        <template is="dom-if" if="{{opencgaSession.token}}">
                                            <a id="logoutButton" role="button" on-click="logout">
                                                <i class="fa fa-sign-out fa-lg"></i> Logout
                                            </a>
                                        </template>
                                    </li>
                                </template>
                            </ul>
                        </div>
                    </div>
                </nav>
            </div>
            <!-- End of navigation bar -->


            <!--Breadcrumb-->
            <ol hidden$="{{!_isBreadcrumbVisible}}" id="breadcrumb" class="breadcrumb" style="margin-bottom: 1px;padding-left: 40px"></ol>


            <!-- This is where main application is rendered -->
            <template is="dom-if" if="{{config.enabledComponents.home}}">
                <div class="center">
                    <div class="content" id="home">
                        <welcome-web project={{opencgaSession.project}} study="{{opencgaSession.study.alias}}" version="{{config.version}}" on-search="quickSearch"></welcome-web>
                    </div>
                </div>
            </template>

            <!-- This is where main IVA application is rendered -->
            <div>
                <template is="dom-if" if="{{config.enabledComponents.dashboard}}">
                    <div class="content" id="dashboard">
                        <!--<opencga-variant-browser opencga-session="{{opencgaSession}}" config="[[config.tools.browser]]"-->
                                                 <!--opencga-client="{{opencgaSession.opencgaClient}}" cellbase-client="{{cellbaseClient}}"-->
                                                 <!--query="{{browserQuery}}"-->
                                                 <!--active="{{config.tools.browser.active}}"-->
                                                 <!--population-frequencies="{{config.populationFrequencies}}"-->
                                                 <!--protein-substitution-scores="{{config.proteinSubstitutionScores}}"-->
                                                 <!--consequence-types="{{config.consequenceTypes}}"-->
                                                 <!--beacon-hosts="{{config.tools.beacon.hosts}}"-->
                                                 <!--on-gene="geneSelected"-->
                                                 <!--on-samplechange="onSampleChange" style="font-size: 12px">-->
                        <!--</opencga-variant-browser>-->
                    </div>
                </template>

                <template is="dom-if" if="{{config.enabledComponents.interpretation}}">
                    <div class="content" id="interpretation">
                        <opencga-variant-interpretation opencga-session="{{opencgaSession}}" config="[[config.tools.interpretation]]"
                                                        opencga-client="{{opencgaSession.opencgaClient}}" cellbase-client="{{cellbaseClient}}"
                                                        active="{{config.tools.interpretation.active}}"
                                                        minorAlleleFreq-frequencies="{{config.populationFrequencies}}"
                                                        protein-substitution-scores="{{config.proteinSubstitutionScores}}"
                                                        consequence-types="{{config.consequenceTypes}}"
                                                        beacon-hosts="{{config.tools.beacon.hosts}}" on-gene="geneSelected"
                                                        on-samplechange="onSampleChange" style="font-size: 12px" >
                        </opencga-variant-interpretation>
                    </div>
                </template>

                <template is="dom-if" if="{{config.enabledComponents.facet}}">
                    <div class="content" id="facet">
                        <opencga-variant-facet opencga-session="{{opencgaSession}}" config="[[config.tools.facet]]"
                                               opencga-client="{{opencgaSession.opencgaClient}}"
                                               cellbase-client="{{cellbaseClient}}"
                                               minorAlleleFreq-frequencies="{{config.populationFrequencies}}"
                                               protein-substitution-scores="{{config.proteinSubstitutionScores}}"
                                               consequence-types="{{config.consequenceTypes}}">
                        </opencga-variant-facet>
                    </div>
                </template>

                <template is="dom-if" if="{{config.enabledComponents.clinical}}">
                    <div class="content" id="clinical">
                        <opencga-variant-clinical opencga-session="{{opencgaSession}}" config="[[config.tools.clinical]]"
                                                  minorAlleleFreq-frequencies="{{config.populationFrequencies}}"
                                                  protein-substitution-scores="{{config.proteinSubstitutionScores}}"
                                                  consequence-types="{{config.consequenceTypes}}"
                                                  opencga-client="{{opencgaClient}}" cellbase-client="{{cellbaseClient}}"
                                                  on-notifymessage="onNotifyMessage" event-notify-name="{{config.notifyEventMessage}}" >
                        </opencga-variant-clinical>
                    </div>
                </template>

                <template is="dom-if" if="{{config.enabledComponents.panel}}">
                    <div class="content" id="panel">
                        <opencga-panel project="{{project}}" study="{{study}}" opencga-client="{{opencgaClient}}" panel-examples="{{config.panelExamples}}"></opencga-panel>
                    </div>
                </template>

                <template is="dom-if" if="{{config.enabledComponents.beacon}}">
                    <div class="content" id="beacon">
                        <variant-beacon opencga-client="{{opencgaClient}}" project="{{opencgaSession.project}}" studies="{{opencgaSession.project.studies}}"
                                        hosts="{{config.tools.beacon.hosts}}">
                        </variant-beacon>
                    </div>
                </template>

                <template is="dom-if" if="{{config.enabledComponents.genomeBrowser}}">
                    <div class="content" id="genomeBrowser">
                        <opencga-genome-browser opencga-session="{{opencgaSession}}" cellbase-client="{{cellbaseClient}}"
                                                opencga-client="{{opencgaClient}}">
                        </opencga-genome-browser>
                    </div>
                </template>

                <template is="dom-if" if="{{config.enabledComponents.gene}}">
                    <div class="content" id="gene" style="margin: auto; width: 90%">
                        <opencga-gene-view opencga-session="{{opencgaSession}}" cellbase-client="{{cellbaseClient}}" opencga-client="{{opencgaClient}}"
                                           project="{{opencgaSession.project}}" study="{{opencgaSession.study}}"
                                           gene="{{gene}}" minorAlleleFreq-frequencies="{{config.populationFrequencies}}"
                                           consequence-types="{{config.consequenceTypes}}"
                                           protein-substitution-scores="{{config.proteinSubstitutionScores}}"
                                           config="{{config.tools.gene}}" summary="{{config.opencga.summary}}">
                        </opencga-gene-view>
                    </div>
                </template>

                <template is="dom-if" if="{{config.enabledComponents.transcript}}">
                    <div class="content feature-view" id="transcript">
                        <opencga-transcript-view cellbase-client="{{cellbaseClient}}" opencga-client="{{opencgaClient}}"
                                                 project="{{opencgaSession.project}}" study="{{opencgaSession.study}}" transcript="{{transcript}}" gene="{{gene}}"
                                                 minorAlleleFreq-frequencies="{{config.populationFrequencies}}" consequence-types="{{config.consequenceTypes}}"
                                                 protein-substitution-scores="{{config.proteinSubstitutionScores}}"
                                                 config="{{config.tools.gene}}">
                        </opencga-transcript-view>
                    </div>
                </template>

                <template is="dom-if" if="{{config.enabledComponents.protein}}">
                    <div class="content feature-view" id="protein">
                        <opencga-protein-view opencga-session="{{opencgaSession}}" cellbase-client="{{cellbaseClient}}" opencga-client="{{opencgaClient}}"
                                              project="{{opencgaSession.project}}" study="{{opencgaSession.study}}"
                                              protein="{{protein}}" minorAlleleFreq-frequencies="{{config.populationFrequencies}}"
                                              consequence-types="{{config.consequenceTypes}}"
                                              protein-substitution-scores="{{config.proteinSubstitutionScores}}"
                                              config="{{config.tools.gene.protein}}">
                        </opencga-protein-view>
                    </div>
                </template>

                <!--<div class="collapse content" id="dashboard">-->
                <!--Not implemented yet!-->
                <!--&lt;!&ndash;<opencga-dahsboard></opencga-dahsboard>&ndash;&gt;-->
                <!--</div>-->

                <template is="dom-if" if="{{config.enabledComponents.login}}">
                    <div class="content" id="login" style="width: 20%; margin: auto; padding-top: 80px">
                        <opencga-login on-login="login" opencga-client="{{opencgaClient}}" login-title="Sign in"
                                       on-notifymessage="onNotifyMessage" event-notify-name="{{config.notifyEventMessage}}">
                        </opencga-login>
                    </div>
                </template>

                <template is="dom-if" if="{{config.enabledComponents.settings}}">
                    <div class="content" id="settings" style="width: 40%; margin: auto">
                        <br>
                        <iva-settings opencga-client="{{opencgaClient}}" on-config="refreshConfig" default-config="{{defaultConfig}}">
                        </iva-settings>
                    </div>
                </template>

                <template is="dom-if" if="{{config.enabledComponents.projects}}">
                    <div class="content" id="projects" style="width: 60%; margin: auto">
                        <opencga-projects opencga-client="{{opencgaClient}}" projects="{{opencgaSession.projects}}" study-summaries="{{studySummaries}}"
                                          on-project="updateProject" on-study="updateStudy">
                        </opencga-projects>
                    </div>
                </template>

                <template is="dom-if" if="{{config.enabledComponents.project}}">
                    <div class="content" id="project">
                        <opencga-project opencga-client="{{opencgaClient}}" project="{{opencgaSession.project}}" study-summaries="{{studySummaries}}"
                                         on-study="updateStudy">
                        </opencga-project>
                    </div>
                </template>

                <template is="dom-if" if="{{config.enabledComponents.samples}}">
                    <div class="content" id="samples">
                        <opencga-sample-browser opencga-session="{{opencgaSession}}" config="{{config.tools.sample}}"></opencga-sample-browser>
                    </div>
                </template>

                <template is="dom-if" if="{{config.enabledComponents.cohorts}}">
                    <div class="content" id="cohorts">
                        <opencga-cohort-browser opencga-session="{{opencgaSession}}" config="{{config.tools.cohort}}"></opencga-cohort-browser>
                    </div>
                </template>
                <!--<div class="collapse content" id="studyInformation">-->
                <!--<opencga-study opencga-client="{{opencgaClient}}" project="{{project}}"-->
                <!--study="{{study}}"></opencga-study>-->
            </div>
        </div>
    </template>

    <script>

        class CatalogApp extends Polymer.Element {

            constructor() {
                super();

                this._init();
            }

            static get is() {
                return 'catalog-app';
            }

            static get properties() {
                return {
                    samples: {
                        type: Array,
                        value: []
                    },
                    studySummaries: {
                        type: Array
                    }
                }
            }

            static get observers() {
                return [
                    "opencgaSessionObserver(opencgaSession.*)"
                ]
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            /**
             * This function creates all the initial configuration
             * @private
             */
            _init() {
                // Create the 'config' , this objects contains all the different configuration
                let _config = application;
                _config.menu.counter = 0;
                _config.cellbase = cellbase;
                _config.tools = tools;
                _config.opencga = opencga;
                // _config.species = DEFAULT_SPECIES;
                _config.enabledComponents = {};
                // _config.panelExamples = diseasePanels;
                // _config.populationFrequencies = populationFrequencies;
                // _config.proteinSubstitutionScores = proteinSubstitutionScores;
                // _config.consequenceTypes = consequenceTypes;
                // _config.sampleBrowser = sampleBrowser;

                // We can customise which components are active by default, this improves the first loading time.
                _config.enabledComponents.home = true;
                _config.enabledComponents.dashboard = false;

                // Enable tools reading the configuration
                for (let tool in _config.tools) {
                    if (UtilsNew.isNotUndefinedOrNull(_config.tools[tool].active)) {
                        _config.enabledComponents[tool] = _config.tools[tool].active;
                    }
                }

                // Enabled components catalog
                let components = ["login", "projects", "project", "samples", "cohorts", "settings", "gene", "transcript", "protein"];
                for (let component of components) {
                    _config.enabledComponents[component] = false;
                }

                // We set the global Polymer variable, this produces one single event
                this.config = _config;


                // We deep clone some config sections for having a default initial copy, this allows us to reset config.
                this.defaultConfig = {};
                // if (UtilsNew.isNotUndefined(populationFrequencies)) {
                //     this.defaultConfig.populationFrequencies = JSON.parse(JSON.stringify(populationFrequencies));
                // }
                // if (UtilsNew.isNotUndefined(proteinSubstitutionScores)) {
                //     this.defaultConfig.proteinSubstitutionScores = JSON.parse(JSON.stringify(proteinSubstitutionScores));
                // }
                // if (UtilsNew.isNotUndefined(consequenceTypes)) {
                //     this.defaultConfig.consequenceTypes = JSON.parse(JSON.stringify(consequenceTypes));
                // }


                // We need to listen to hash fragment changes to update the display and breadcrumb
                let _this = this;
                window.onhashchange = function () {
                    _this.hashFragmentListener(_this);
                };

                // Remember the tool that was previously set
                this.tool = window.location.hash.split('/')[0];
                if (UtilsNew.isEmpty(this.tool)) {
                    this.tool = "#home" ;
                }

                // Go to the page that tool has
                if (window.location.hash !== this.tool) {
                    window.location.hash = this.tool;
                }


                // Other initialisations
                // this.icd10 = ICD_10;
                this._isBreadcrumbVisible = false;
                // This manages the samples selected in each tool for updating the breadcrumb
                this.samples = [];
                this._samplesPerTool = {};


                // Initialise clients and create the session
                this.opencgaClientConfig = new OpenCGAClientConfig(this.config.opencga.host, this.config.opencga.version, true, this.config.opencga.cookie.prefix);
                this.opencgaClient = new OpenCGAClient(this.opencgaClientConfig);

                this.cellBaseClientConfig = new CellBaseClientConfig(this.config.cellbase.hosts, this.config.cellbase.version, "hsapiens");
                this.cellbaseClient = new CellBaseClient(this.cellBaseClientConfig);

                let sid = Cookies.get(this.config.opencga.cookie.prefix + "_sid");
                if (UtilsNew.isNotEmpty(sid)) {    // && !this._publicMode
                    this.opencgaClient._config.sessionId = sid;
                    this._createOpenCGASession();
                    // This must happen after creating the OpencgaClient
                    this.checkSessionActive();
                    this.intervalCheckSession = setInterval(this.checkSessionActive.bind(this), this.config.session.checkTime);
                } else {
                    this._createOpencgaSessionFromConfig();
                }
            }

            opencgaSessionObserver() {
                this.renderHashFragments();
                this.renderBreadcrumb();
            }

            _createOpenCGASession() {
                let _this = this;
                let opencgaSession = this.opencgaClient.createSession()
                    .then(function (response) {
                        _this.opencgaSession = Object.assign({}, response); // this forces the observer to be executed.
                    })
                    .catch(function (response) {
                        console.log("An error when creating the OpenCGA session: ", response);
                    });
            }

            _createOpencgaSessionFromConfig() {
                // Create a private opencga-session to avoid calling to the Observer
                let opencgaSession = this.opencgaClient.createAnonymousSession();

                // If 'config.opencga.anonymous' exists and contains either 'user' or 'projects'
                if (UtilsNew.isNotUndefinedOrNull(this.config.opencga.anonymous) && Object.keys(this.config.opencga.anonymous).length > 0) {
                    // If 'projects' is defined we only load those projects
                    if (UtilsNew.isNotUndefinedOrNull(this.config.opencga.anonymous.projects)) {
                        if (this.config.opencga.anonymous.projects.length > 0) {
                            // TODO we must query projects/info URL to get the whole object
                            opencgaSession.projects = this.config.opencga.anonymous.projects;
                            if (UtilsNew.isNotEmptyArray(opencgaSession.projects[0].studies)) {
                                opencgaSession.project = opencgaSession.projects[0];
                                opencgaSession.study = opencgaSession.projects[0].studies[0];
                            }
                        }

                        // This triggers the event and call to opencgaSessionObserver
                        this.set("opencgaSession", opencgaSession);
                    } else {
                        // When no 'projects' is defined we fetch all public projects
                        if (UtilsNew.isNotUndefinedOrNull(this.config.opencga.anonymous.user)) {
                            let _this = this;
                            this.opencgaClient.users().getProjects(this.config.opencga.anonymous.user, {})
                                .then(function (response) {
                                    // _this._setup(_projects);

                                    opencgaSession.projects = response.response[0].result;
                                    if (UtilsNew.isNotEmptyArray(opencgaSession.projects) && UtilsNew.isNotEmptyArray(opencgaSession.projects[0].studies)) {
                                        // this sets the current active project and study
                                        opencgaSession.project = opencgaSession.projects[0];
                                        opencgaSession.study = opencgaSession.projects[0].studies[0];
                                    }

                                    // This triggers the event and call to opencgaSessionObserver
                                    _this.set("opencgaSession", opencgaSession);
                                })
                                .catch(function (response) {
                                    console.log("An error when getting projects: ", response);
                                });
                        }
                    }
                } else {
                    // This triggers the event and call to opencgaSessionObserver
                    this.set("opencgaSession", opencgaSession);
                }
            }

            login(credentials) {
                // This creates a new authenticated opencga-session object
                this.opencgaClient._config.sessionId = credentials.detail.sessionId;
                this._createOpenCGASession();

                this.set('config.menu', application.menu.slice()); // Do not remove: this is for refreshing the menu

                if (this.tool === "#login") {
                    this.tool = "#home";
                }

                // 60000 ms = 1 min. Every 1 min we check if session is close to expire.
                this.intervalCheckSession = setInterval(this.checkSessionActive.bind(this), this.config.session.checkTime);
            }

            logout() {
                // this delete sessionId in the client and removes the Cookies
                this.opencgaClient.users().logout();
                this._createOpencgaSessionFromConfig();

                this.set('config.menu', application.menu.slice()); // Do not remove: this is for refreshing the menu

                this.tool = "#home";
                window.location.hash = "home";

                window.clearInterval(this.intervalCheckSession);
            }

            checkSessionActive() {
                let _message = "";
                // We check if refresh token has updated session id cookie
                // let sid = Cookies.get(this.config.opencga.cookie.prefix + "_sid");

                if (UtilsNew.isNotUndefinedOrNull(this.opencgaClient._config.sessionId)) {    // UtilsNew.isNotEmpty(this.opencgaSession.token) &&
                    // this.sessionId = sid;
                    let decoded = jwt_decode(this.opencgaClient._config.sessionId);
                    let currentTime = new Date().getTime();
                    let remainingTime = ((decoded.exp * 1000) - currentTime);
                    // 600000 ms = 10 min = 1000(1sec) * 60(60 sec = 1min) * 10(10 min)
                    if (remainingTime <= this.config.session.maxRemainingTime && remainingTime >= this.config.session.minRemainingTime) {
                        let remainingMinutes = Math.floor(remainingTime / this.config.session.minRemainingTime);
                        _message = "Your session is close to expire. <strong>" + remainingMinutes + ` minutes remaining</strong>. <a href="#" onclick='eval(NotificationUtils.refreshToken()); return false;'>Click here to refresh</a>`;
                    } else {
                        if (remainingTime < this.config.session.minRemainingTime) {
                            _message = "Your session has expired.";
                            this.logout();
                            window.clearInterval(this.intervalCheckSession);
                        } else {
                            if (UtilsNew.isNotUndefinedOrNull(this.notifySession)) {
                                NotificationUtils.closeNotify(this.notifySession);
                            }
                            return;
                        }
                    }
                } else {
                    // _message = "Your session has expired.";
                    // window.clearInterval(this.intervalCheckSession);
                }
                // delay = 0 to fix the notify until user closes it.
                if (UtilsNew.isNotEmpty(_message)) {
                    this.notifySession = NotificationUtils.showNotify(_message, UtilsNew.MESSAGE_INFO, {}, {
                        delay: 0,
                        onClosed: this.onCloseRefreshNotify.bind(this)
                    }, this.opencgaClient, this.notifySession);
                }
            }

            onCloseRefreshNotify() {
                delete this.notifySession;
            }

            changeTool(e) {
                if (UtilsNew.isNotUndefined(e)) {
                    e.preventDefault(); // prevents the hash change to "#" and allows to manipulate the hash fragment as needed
                }

                if (UtilsNew.isNotUndefined(e.target) && UtilsNew.isNotUndefined(e.target.attributes.href)) {
//                    $(e.target.attributes.href.value).show(); // get the href and use it find which div to show
                    this.tool = e.target.attributes.href.value;
                    if (UtilsNew.isNotUndefinedOrNull(this._samplesPerTool)) {
                        if (this._samplesPerTool.hasOwnProperty(this.tool.replace("#", ""))) {
                            this.samples = this._samplesPerTool[this.tool.replace("#", "")];
                        } else {
                            this.samples = [];
                        }
                    }
                    this.renderBreadcrumb()
                } else {
                    this.tool = "#home";
                }

                this.renderHashFragments();
            }

            _setup(projects) {
                // We check that at least one project with one study exist, otherwise we do not do anything
                if (UtilsNew.isNotUndefined(projects) && projects.length > 0 && projects[0].studies.length > 0) {
                    this.projects = projects;
                    this.project = projects[0];
                    this.study = projects[0].studies[0];

                    let _this = this;
                    let projectPromises = [];
                    projects.forEach(function (project) {
                        let studyPromises = [];
                        project.studies.forEach(function (study) {
                            studyPromises.push(_this.opencgaClient.studies().summary(project.alias + ":" + study.alias));
                        });
                        projectPromises.push(Promise.all(studyPromises)
                            .then(function (responses) {
                                let studies = [];
                                responses.forEach(function (response) {
                                    let study = response.response[0].result[0];
                                    study.creationDate = moment(study.creationDate, "YYYYMMDDHHmmss").format('D MMM YY');
                                    studies.push(study);
                                });
                                return studies;
                            }));
                    });

                    let _projects = [];
                    Promise.all(projectPromises)
                        .then(function (responses) {
                            for (let i = 0; i < responses.length; i++) {
                                _projects.push({
                                    id: _this.projects[i].id,
                                    alias: _this.projects[i].alias,
                                    name: _this.projects[i].name,
                                    organism: _this.projects[i].organism,
                                    studies: responses[i]
                                });
                            }
                            _this.studySummaries = _projects;
                        });
                }
            }

            renderHashFragments() {
                console.log("renderHashFragments - DEBUG")

                let hashFrag = this.tool;
                if (UtilsNew.isNotUndefined(this.opencgaSession.project) && UtilsNew.isNotEmpty(this.opencgaSession.project.alias)) {

                    hashFrag += "/" + this.opencgaSession.project.alias;
                    if (UtilsNew.isNotUndefined(this.opencgaSession.study) && UtilsNew.isNotEmpty(this.opencgaSession.study.alias)) {
                        hashFrag += "/" + this.opencgaSession.study.alias;
                    }
                }

                if (window.location.hash === hashFrag) {
                    this.hashFragmentListener(this);
                } else {
                    window.location.hash = hashFrag;
                }
            }

            hashFragmentListener(ctx) {
                console.log("hashFragmentListener - DEBUG")
                // Hide all elements
                for (let element in this.config.enabledComponents) {
                    if (UtilsNew.isNotUndefined(this.config.enabledComponents[element])) {
                        this.set("config.enabledComponents." + element, false);
                    }
                }

                let arr = window.location.hash.split('/');
                let [hashTool, hashProject, hashStudy, feature] = arr;

                // Stopping the recursive call
                if (hashTool !== this.tool || (UtilsNew.isNotUndefined(this.opencgaSession) && UtilsNew.isNotUndefined(this.opencgaSession.project) && hashProject !== this.opencgaSession.project.alias) ||
                    (UtilsNew.isNotUndefined(this.study) && hashStudy !== this.opencgaSession.study.alias)) {
                    if (arr.length > 1) {
                        // Field 'project' is being observed, just in case Polymer triggers
                        // an unnecessary event we can check they are really different
                        if (ctx.opencgaSession.project.alias !== hashProject) {
                            ctx.opencgaSession.project.alias = hashProject;
                        }
                        if (arr.length > 2 && ctx.opencgaSession.study !== hashStudy) {
                            for (let i = 0; i < ctx.opencgaSession.projects.length; i++) {
                                if (ctx.opencgaSession.projects[i].name === ctx.opencgaSession.project.name
                                    || ctx.opencgaSession.projects[i].alias === ctx.opencgaSession.project.alias) {
                                    for (let j = 0; j < ctx.opencgaSession.projects[i].studies.length; j++) {
                                        if (ctx.opencgaSession.projects[i].studies[j].name === hashStudy || ctx.opencgaSession.projects[i].studies[j].alias === hashStudy) {
                                            ctx.opencgaSession.study = ctx.opencgaSession.projects[i].studies[j];
                                            break;
                                        }
                                    }
                                    break;
                                }
                            }
                        }
                    }

                    if (UtilsNew.isNotEmpty(feature)) {
                        if (hashTool === "#protein") {
                            ctx.protein = feature;
                        } else if (feature.startsWith("ENST")) {
                            ctx.transcript = feature;
                        } else {
                            ctx.gene = feature;
                        }
                    }
                    ctx.tool = hashTool;
                }

                if (UtilsNew.isNotUndefined(this.config.enabledComponents[this.tool.replace("#", "")])) {
                    this.set("config.enabledComponents." + this.tool.replace("#", ""), true);
                }
            }

            refreshConfig(e) {
                let colorConfig = e.detail.config;
                let _this = this;
                for (let key in colorConfig) {
                    switch (key) {
                        case "consequenceTypes":
                            let ctColor = colorConfig[key].color;
                            for (let impact in ctColor) {
                                _this.consequenceTypes.color[impact] = ctColor[impact];
                            }
                            let ctModified = Object.assign({}, _this.consequenceTypes);
                            _this.set('consequenceTypes', ctModified);
                            break;
                        case "proteinSubstitutionScores":
                            for (let source in colorConfig[key]) {
                                if (source === "sift") {
                                    let sift = colorConfig[key].sift;
                                    for (let prediction in sift) {
                                        _this.proteinSubstitutionScores.sift[prediction] = sift[prediction];
                                    }
                                } else if (source === "polyphen") {
                                    let polyphen = colorConfig[key].polyphen;
                                    for (let pred in polyphen) {
                                        _this.proteinSubstitutionScores.polyphen[pred] = polyphen[pred];
                                    }
                                }
                            }
                            let pssModified = Object.assign({}, _this.proteinSubstitutionScores);
                            _this.set('proteinSubstitutionScores', pssModified);
                            break;
                        case "populationFrequencies":
                            let pfColor = colorConfig[key].color;
                            for (let i in pfColor) {
                                _this.populationFrequencies.color[i] = pfColor[i];
                            }
                            let pfModified = Object.assign({}, _this.populationFrequencies);
                            _this.set('populationFrequencies', pfModified);
                            break;
                    }
                }
            }

            onStudySelect(e) {
                e.preventDefault(); // prevents the hash change to "#" and allows to manipulate the hash fragment as needed

                let _project, _study;
                for (let i = 0; i < this.opencgaSession.projects.length; i++) {
                    if (this.opencgaSession.projects[i].name === e.target.dataProject) {
                        _project = this.opencgaSession.projects[i];
                        for (let j = 0; j < this.opencgaSession.projects[i].studies.length; j++) {
                            if (this.opencgaSession.projects[i].studies[j].name === e.target.innerHTML
                                || this.opencgaSession.projects[i].studies[j].alias === e.target.innerHTML) {
                                _study = this.opencgaSession.projects[i].studies[j];
                                break;
                            }
                        }
                        break;
                    }
                }
                this.opencgaSession = Object.assign({}, this.opencgaSession, {project: _project, study: _study});
            }

            updateProject(e) {
                for (let i = 0; i < this.projects.length; i++) {
                    if (this.projects[i].name === e.detail.project.name) { // getting the selected project from projects array
                        this.project = this.projects[i];
                    }
                }
                this.tool = "#project";
                this.renderHashFragments();
                this.renderBreadcrumb();
            }

            updateStudy(e) {
                if (UtilsNew.isNotUndefined(e.detail.project) && UtilsNew.isNotEmpty(e.detail.project.name)) {
                    this.project = e.detail.project;
                }
                for (let i = 0; i < this.project.studies.length; i++) {
                    if (this.project.studies[i].name === e.detail.study.name || this.project.studies[i].alias === e.detail.study.alias) {
                        this.study = this.project.studies[i];
                    }
                }

//                TODO: Opencga study will be shown later. For now variant browser is shown when the study changes
//                this.tool = "studyInformation";
                this.tool = "#browser";
                this.renderHashFragments();
                this.renderBreadcrumb();
            }

            onSampleChange(e) {
                if (UtilsNew.isNotUndefinedOrNull(this.samples) && UtilsNew.isNotUndefinedOrNull(e.detail)) {
                    this.set('samples', e.detail.samples);
                    this._samplesPerTool[this.tool.replace("#", "")] = this.samples;

                    this.renderBreadcrumb();
                }
            }

            buildQuery(e) {
                let query = {};
                let value = "";
                if (UtilsNew.isNotUndefined(e) && UtilsNew.isNotUndefined(e.detail.value)) {
                    value = e.detail.value; // It takes care of the fired event from welcome.html
                } else if (UtilsNew.isNotUndefined(e) && e.keyCode == '13' || UtilsNew.isNotUndefined(e) && e.type == "click") {
                    value = this.$.searchTextBox.value;  // When enter key is pressed or search icon is clicked, it takes the value entered and assign it
                }

                if (value !== "") {
                    if (value.startsWith("rs") || value.split(':').length > 2) {
                        query.ids = value;
                    } else if (value.indexOf(':') > -1 && value.indexOf('-') > -1) {
                        query.region = value;
                    } else if (value.startsWith("GO:")) {
                        query["annot-go"] = value;
                    } else if (value.startsWith("HP:")) {
                        query["annot-hpo"] = value;
                    } else if (value.startsWith("ENST")) {
                        this.transcript = value;
                        this.tool = "#transcript";
                    } else {
                        this.gene = value.toUpperCase();
                        this.tool = "#gene";
                    }

                    // This query object is built for variant browser. Only when the queries to browser are made, we are setting the tool to browser
                    if (Object.keys(query).length > 0) {
                        this._query = query;
                        this.tool = "#browser";
                    }

                    this.renderHashFragments();
                    this.$.searchTextBox.value = ""; // Empty the value of search text box when search is complete and respective view is loaded
                }
            }

            quickSearch(e) {
                this.tool = "#browser";
                window.location.hash = "browser/" + this.opencgaSession.project.alias + "/" + this.opencgaSession.study.alias;
                this.browserQuery = {xref: e.detail.value};
            }

            _checkBreadcrumbVisible() {
                if (UtilsNew.isNotUndefinedOrNull(this.config) && UtilsNew.isNotUndefinedOrNull(this.opencgaSession)) {
                    this._isBreadcrumbVisible = this.config.breadcrumb.visible && this.opencgaSession.projects !== undefined && this.opencgaSession.projects.length !== 0;
                }
            }

            renderBreadcrumb() {
                this._checkBreadcrumbVisible();

                let breadcrumbElement = PolymerUtils.getElementById("breadcrumb");

                if (UtilsNew.isNotNull(breadcrumbElement) && UtilsNew.isNotUndefined(this.config)
                    && UtilsNew.isNotUndefinedOrNull(this.opencgaSession) && UtilsNew.isNotEmptyArray(this.opencgaSession.projects)) {

                    // If there is no project in config, breadcrumb is set private so that it is shown only when logged in
                    // if (UtilsNew.isUndefined(this.config.opencga.projects) || this.config.opencga.projects.length === 0) {
                    //     this.config.breadcrumb.visibility = "private";
                    // }

                    // we empty everything
//                    console.log(this.breadcrumbElement)
                    PolymerUtils.innerHTML("breadcrumb", "");
                    // we add the 'Projects' link
                    let projects = this._createBreadcrumbElement(this.config.breadcrumb.title, false, this.config.breadcrumb.title);
                    breadcrumbElement.appendChild(projects);

                    // We first check if one study is selected, for this study must be defined and have at least one key
                    if (UtilsNew.isUndefined(this.opencgaSession.study) || Object.keys(this.opencgaSession.study).length === 0) {
                        if (UtilsNew.isNotUndefinedOrNull(this.opencgaSession.project)) {
                            let project = this._createBreadcrumbElement(this.opencgaSession.project.alias, true, "project"); // render only project if exists
                            breadcrumbElement.appendChild(project);
                        }
                    } else {
                        let project = this._createBreadcrumbElement(this.opencgaSession.project.alias, false, "project");
                        breadcrumbElement.appendChild(project);

                        if (UtilsNew.isNotUndefined(this.samples) && this.samples.length > 0) {
                            let study = this._createBreadcrumbElement(this.opencgaSession.study.alias, false, "study");
                            let sampleNames = [];
                            for (let i in this.samples) {
                                sampleNames.push(this.samples[i].name);
                            }
                            let samples = this._createBreadcrumbElement(sampleNames.join(","), true, "sample");
                            breadcrumbElement.appendChild(study);
                            breadcrumbElement.appendChild(samples);
                        } else {
                            let study = this._createBreadcrumbElement(this.opencgaSession.study.alias, true, "study");
                            breadcrumbElement.appendChild(study);
                        }
                    }

                    let _this = this;
                    PolymerUtils.querySelectorAll(".breadcrumb li a").forEach(function (element) {
                        element.addEventListener('click', function (e) {
                            e.preventDefault();
                            switch (e.target.dataset.category) {
                                case _this.config.breadcrumb.title:
                                    _this.tool = "projects";
                                    break;
                                case "project":
                                    _this.tool = "project";
                                    break;
                                case "study":
                                    _this.tool = "browser";
                                    break;
                            }
                            _this.renderHashFragments();
                        });
                    });
                }
            }

            _createBreadcrumbElement(name, active, category) {
                // name can be undefined when Polymer initialise
                if (typeof name === "undefined") {
                    name = "undefined";
                }

                let li = document.createElement("li");
                if (active === true) {
                    li.setAttribute("class", "active");
                    li.textContent = name;
                } else {
                    let a = document.createElement("a");
                    a.setAttribute("href", "#");
                    a.setAttribute("class", "");
                    a.setAttribute("data-category", category);
                    a.textContent = name;
                    li.appendChild(a);
                }
                return li;
            }

            _isMenuItemVisible(item) {
                switch (item.visibility) {
                    case 'public':
                        return true;
                    case 'private':
                        return UtilsNew.isNotUndefinedOrNull(this.opencgaSession) && UtilsNew.isNotEmpty(this.opencgaSession.token);
                    case 'none':
                    default:
                        return false;
                }
            }

            onNotifyMessage(e) {
                NotificationUtils.closeNotify(this.notifySession);
                NotificationUtils.showNotify(e.detail.message, e.detail.type, e.detail.options, e.detail.settings);
            }
        }

        customElements.define(CatalogApp.is, CatalogApp);
    </script>
</dom-module>
